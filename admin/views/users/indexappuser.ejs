<!DOCTYPE html>
<html :class="{ 'theme-dark': dark }" x-data="data()" lang="en">

<head>
  <%- include('../include/_head') %>
  
  <!-- DataTables CSS --><!-- Tailwind-compatible DataTables CSS -->
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css" rel="stylesheet">

  
  <!-- DataTables jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  
  <!-- Chart Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js" defer></script>
  <script src="/js/charts-pie.js" defer></script>
  <script src="/js/charts-bars.js" defer></script>
</head>
<style>
  /* Wrap the info and pagination into a flex row */
  div.dataTables_wrapper .dataTables_info,
  div.dataTables_wrapper .dataTables_paginate {
    margin-top: 1rem;
  }

  div.dataTables_wrapper .dataTables_length,
  div.dataTables_wrapper .dataTables_filter,
  div.dataTables_wrapper .dataTables_info,
  div.dataTables_wrapper .dataTables_paginate {
    padding: 0.5rem 1rem;
  }
  div.dataTables_wrapper .dataTables_info {
    padding: 0; /* Remove padding for info line */
    margin-top: 0.0;
    margin-bottom: 0.25;
}
div.dataTables_wrapper .dataTables_paginate {
  margin-top: 0.0;
  margin-bottom: 0.25;
}
  div.dataTables_wrapper .dataTables_info_paginate_wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap; /* Stack on mobile */
    margin-top: 0rem;
  }

  /* Custom pagination buttons */
  .dataTables_wrapper .dataTables_paginate .paginate_button {
 
 font-size: 0.875rem;
 border: 0 solid #d5d6d7;
 border-radius: 0.0;
 padding: 0.25rem 0.50rem;
 margin: 0 0.25rem;
 cursor: pointer;
}

.dataTables_wrapper .dataTables_paginate .paginate_button.current {
 background-color: #EC1F95;
 color: white;
}

  .dataTables_wrapper .dataTables_info {
    font-size: 0.875rem;
    color: #4B5563;
  }
  /* Style for empty table row */
.dataTables_empty {
    text-align: center !important;  /* Center text */
    font-weight: bold;              /* Make it bold */
    font-size: 16px;                /* Slightly bigger font */
    color: #888;                    /* Light gray text */
    background-color: #f8f9fa;      /* Light background */
    padding: 15px !important;       /* Add more padding */
    border-radius: 6px;             /* Smooth rounded corners */
}

/* Adjust for dark mode */
.dark .dataTables_empty {
    color: #bbb;                    /* Light text for dark mode */
    background-color: #222;          /* Darker background */
}

</style>



<body>
  <div class="flex h-screen bg-gray-50 dark:bg-gray-900" :class="{ 'overflow-hidden': isSideMenuOpen }">
    <%- include('../include/_sidebar') %>

    <div class="flex flex-col flex-1 w-full">
      <%- include('../include/_header') %>

      <!-- Content -->
      <main class="h-full overflow-y-auto">
        <div class="container mx-auto grid">
          <div class="flex justify-between">
            <h2 class="my-6 text-2xl font-semibold text-gray-700 dark:text-gray-200">
              Gossiper
            </h2>
            <div  class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-50">
              <a href="/admin/createappuser" class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-50">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Add New
              </a>
              <button onclick="exportTableToCSV('gossipers.csv')" class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-50">
                Export CSV
              </button>
            </div>
          </div>

          <!-- Table -->
          <div class="w-full mb-8 overflow-hidden rounded-lg shadow-xs">
            <div class="w-full overflow-x-auto">
              <table id="usersTable" class="display w-full whitespace-no-wrap">
                <thead>
                  <tr class="text-xs font-semibold tracking-wide text-left text-gray-500 uppercase border-b dark:border-gray-700 bg-gray-50 dark:text-gray-400 dark:bg-gray-800">
                    <th class="px-4 py-3">Profile</th>
                    <th class="px-4 py-3">User Name</th>
                    <th class="px-4 py-3">Email</th>
                    <th class="px-4 py-3">Status</th>
                    <th class="px-4 py-3">Created Date</th>
                    <th class="px-4 py-3">QR Code</th>
                    <th class="px-4 py-3">Action</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y dark:divide-gray-700 dark:bg-gray-800">
                  <% if (appUserData.length > 0) { %>
                    <% appUserData.forEach(function(user) { %>
                      <tr class="text-gray-700 dark:text-gray-400">
                        <td class="px-4 py-3">
                          <div class="flex items-center text-sm">
                            <div class="relative  w-8 h-8 mr-3 rounded-full ">
                              <img class="object-cover w-full h-full rounded-full"
                                src="/api/<%= user.profile_image ? user.profile_image : 'assets/img/default-user.png' %>"
                                alt="<%= user.user_name %>" loading="lazy" />
                              <div class="absolute inset-0 rounded-full shadow-inner" aria-hidden="true"></div>
                            </div>
                          </div>
                        </td>
                        <td class="px-4 py-3">
                          <p class="font-semibold"><%= user.user_name %></p>
                          <p class="text-xs text-gray-600 dark:text-gray-400">
                            <%= user.first_name %> <%= user.last_name %>
                          </p>
                        </td>
                        <td class="px-4 py-3 text-sm"><a href="mailto:<%= user.email %>"><%= user.email %></a></td>
                        <% if (user.suspend == 0) { %>  <td class="px-4 py-3 text-xs">
                          <span class="px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">
                             Active   
                          </span>
                        </td>   <% } else { %>  <td class="px-4 py-3 text-xs">
                          <span class="px-2 py-1 font-semibold leading-tight text-red-700 bg-red-100 rounded-full dark:bg-red-700 dark:text-red-100">
                            Suspend   
                          </span>
                        </td>  <% } %> 
                        
                        <td class="px-4 py-3 text-sm"><%= user.created_at ? user.created_at.toISOString().split('T')[0] : '' %></td>
                        
                        <td class="px-4 py-3">
                          <button onclick="downloadQR(<%= user.id %>)">Download QR</button>
                          
                        </td>

                        <td class="px-4 py-3 text-sm">
                          <a href="/admin/editappuser/<%= user.id %>" class="text-blue-500 hover:text-blue-700"><b>Edit</b></a>
                          <span class="mx-2">|</span>
                          <a href="/admin/deleteappuser/<%= user.id %>" class="text-red-500 hover:text-red-700" onclick="return confirm('Are you sure you want to delete this user?')"><b>Delete</b></a>
                          <span class="mx-2">|</span>
                          <% if (user.suspend == 0) { %> 
                            <a href="/admin/appuser/suspend/<%= user.id %>?status=1&p=1" class="text-red-500 hover:text-red-700" onclick="return confirm('Are you sure you want to suspend this user?')"><b>Suspend</b></a>
                          <% } else { %> 
                            <a href="/admin/appuser/suspend/<%= user.id %>?status=0&p=1" class="text-green-500 hover:text-green-700" onclick="return confirm('Are you sure you want to unsuspend this user?')"><b>Unsuspend</b></a>
                          <% } %> 
                        </td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
          <!-- Table end -->
        </div>
      </main>
      <!-- End content -->
    </div>
  </div>

  <%- include('../include/_footer') %>

  <script>
async function downloadQR(userid) {
  const id = userid; // example user ID
  const response = await fetch(`/qr/${id}`);
  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);

  // Show QR on page
  //document.getElementById("qrImage").src = url;

  // Trigger download
  const a = document.createElement("a");
  a.href = url;
  a.download = "profile-qr.png";
  document.body.appendChild(a);
  a.click();
  a.remove();
}
</script>

  <script>
    function exportTableToCSV(filename) {
      const csv = [];
      const table = document.getElementById('usersTable');
      const rows = table.querySelectorAll('tbody tr');
  
      // Add custom headers manually
      csv.push('"User Name","First Name","Last Name","Email","Status","Created Date"');
  
      rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        if (cols.length === 0) return;
  
        // Extract and sanitize each field
        const userName = cols[1]?.querySelector('p.font-semibold')?.innerText.trim() || '';
        const fullNameText = cols[1]?.querySelector('p.text-xs')?.innerText.trim() || '';
        const [firstName = '', lastName = ''] = fullNameText.split(' ');
        const email = cols[2]?.innerText.trim() || '';
        const status = cols[3]?.innerText.trim() || '';
        let createdDate = cols[4]?.innerText.trim() || '';
        if (/\d{4}-\d{2}-\d{2}/.test(createdDate)) {
          createdDate = '\t' + createdDate;
        }
  
        // Build CSV row
        const rowData = [
          userName, firstName, lastName, email, status, createdDate
        ].map(val => `"${val.replace(/"/g, '""')}"`);
  
        csv.push(rowData.join(','));
      });
  
      // Download
      const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
      const downloadLink = document.createElement('a');
      downloadLink.download = filename;
      downloadLink.href = URL.createObjectURL(csvFile);
      downloadLink.style.display = 'none';
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }
</script>
  <!-- DataTables Initialization -->
  <script>
  $(document).ready(function () {
    const table = $('#usersTable').DataTable({
      pageLength: 100,
      lengthChange: false,
      ordering: false,
      searching: false,
      responsive: true
    });
  
    // Combine info + pagination into one wrapper
    setTimeout(() => {
      const $wrapper = $('#usersTable_wrapper');
      const $info = $wrapper.find('.dataTables_info');
      const $paginate = $wrapper.find('.dataTables_paginate');
  
      const $customWrapper = $('<div class="dataTables_info_paginate_wrapper w-full px-4"></div>');
      $info.appendTo($customWrapper);
      $paginate.appendTo($customWrapper);
      $wrapper.append($customWrapper);
    }, 0);



      // Sidebar color effect
      $('.dashboard-sidebar').each(function() {
        var spanElement = $('<span class="absolute inset-y-0 left-0 w-1 rounded-tr-lg rounded-br-lg" style="background-color:var(--blue-color);" aria-hidden="true"></span>');
        $(this).before(spanElement);
        $(this).addClass('text-gray-800');
      });
    });
  </script>

</body>
</html>
